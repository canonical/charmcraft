summary: pack a charm that uses several lifecycle mechanisms and extra files

environment:
  PROFILE/simple_bases,simple_platforms: simple
  PROFILE/machine_bases,machine_platforms: machine
  PROFILE/kubernetes_bases,kubernetes_platforms: kubernetes
  BASE_TYPE/simple_bases,machine_bases,kubernetes_bases: bases
  BASE_TYPE/simple_platforms,machine_platforms,kubernetes_platforms: platforms

include:
  - tests/

kill-timeout: 30m

prepare: |
  tests.pkgs install pipx python3-venv
  pipx install --force tox

restore: |
  pushd "${PROFILE}-${BASE_TYPE}-charm"
  charmcraft clean
  popd

  rm -rf "${PROFILE}-${BASE_TYPE}-charm"

execute: |
  cd "${PROFILE}-${BASE_TYPE}-charm"
  charmcraft pack --verbose
  ~/.local/bin/tox run
  test -f "${PROFILE}-${BASE_TYPE}"-charm*.charm || ERROR $(ls -l)
  # Charmcraft 3.0 uses the craft-parts standard prime keyword that only
  # includes the specifically mentioned files
  unzip -c "${PROFILE}-${BASE_TYPE}"-charm*.charm hello.txt | grep "^Hello, world!"
  unzip -l "${PROFILE}-${BASE_TYPE}"-charm*.charm | NOMATCH "venv/ops/charm.py"
  unzip -l "${PROFILE}-${BASE_TYPE}"-charm*.charm | MATCH extra_file.txt
  unzip -l "${PROFILE}-${BASE_TYPE}"-charm*.charm | NOMATCH secrets.txt
