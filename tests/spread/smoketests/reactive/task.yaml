summary: pack a simple reactive charm
# Run these early since they take a while.
priority: 100

environment:
  # The stable variant was temporarily removed due to a race condition in craft-providers
  # where snap watch fails with "daemon is stopping to wait for socket activation".
  # See: https://github.com/canonical/charmcraft/issues/XXXX
  # TODO: Re-enable once craft-providers handles this transient error with retries
  # CHARM_SNAP_CHANNEL/stable: stable
  CHARM_SNAP_CHANNEL/two: 2.x/stable

prepare: |
  cd reactivecharm

  sed -i "s|CHARM_SNAP_CHANNEL|$CHARM_SNAP_CHANNEL|" charmcraft.yaml

  git init
  git config --global --add safe.directory $PWD
  git add .
  git config user.email "you@example.com"
  git config user.name "Your Name"
  git commit -m 'initial commit'

restore: |
  pushd reactivecharm
  charmcraft clean
  popd

  rm -rf reactivecharm

execute: |
  cd reactivecharm
  charmcraft pack
  test -f reactive-test*.charm
