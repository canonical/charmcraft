summary: upload charm from outside project directory

include:
  - tests/
  - charm/
  - upload-dir/

prepare: |
  tests.pkgs install jq

restore: |
  pushd charm
  charmcraft clean
  popd

execute: |
  # Set the charm name in the charmcraft.yaml
  cd charm
  sed -i "1i name: $CHARM_DEFAULT_NAME" charmcraft.yaml
  
  # pack the charm
  charmcraft pack --verbose
  test -f $CHARM_DEFAULT_NAME*.charm
  charm_filepath=$(ls $CHARM_DEFAULT_NAME*.charm)
  
  # Move the charm file to the upload directory (outside project)
  mv $charm_filepath ../upload-dir/
  
  # Change to the upload directory (which has no charmcraft.yaml)
  cd ../upload-dir
  
  # Verify we're outside the project directory
  if [ -f charmcraft.yaml ]; then
    echo "ERROR: charmcraft.yaml should not exist in upload directory"
    exit 1
  fi
  
  # Upload the charm from outside the project directory
  # This should NOT crash with "Project not configured yet" error
  charm_file=$(ls $CHARM_DEFAULT_NAME*.charm)
  uploaded_revno=$(charmcraft upload $charm_file --format=json | jq .revision)
  
  # Verify we got a valid revision number
  if [ -z "$uploaded_revno" ] || [ "$uploaded_revno" == "null" ]; then
    echo "ERROR: Failed to upload charm or get revision number"
    exit 1
  fi
  
  echo "Successfully uploaded charm from outside project directory. Revision: $uploaded_revno"
