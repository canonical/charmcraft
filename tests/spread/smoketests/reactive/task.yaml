summary: pack a simple reactive charm
# Run these early since they take a while.
priority: 100

environment:
  # The stable variant was temporarily removed due to a race condition in craft-providers
  # where snap watch fails with "daemon is stopping to wait for socket activation" during
  # base instance setup. This is a transient snapd error that craft-providers should handle
  # with retries but currently doesn't. The two variant tests the same functionality (reactive
  # charm building) with charm-tools 2.x instead of 3.x.
  # TODO: Re-enable once craft-providers handles this transient snapd error with retries
  # TODO: File an issue with craft-providers about adding retry logic for snap watch failures
  # CHARM_SNAP_CHANNEL/stable: stable
  CHARM_SNAP_CHANNEL/two: 2.x/stable

prepare: |
  cd reactivecharm

  sed -i "s|CHARM_SNAP_CHANNEL|$CHARM_SNAP_CHANNEL|" charmcraft.yaml

  git init
  git config --global --add safe.directory $PWD
  git add .
  git config user.email "you@example.com"
  git config user.name "Your Name"
  git commit -m 'initial commit'

restore: |
  pushd reactivecharm
  charmcraft clean
  popd

  rm -rf reactivecharm

execute: |
  cd reactivecharm
  charmcraft pack
  test -f reactive-test*.charm
