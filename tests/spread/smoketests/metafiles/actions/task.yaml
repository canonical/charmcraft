summary: create a charm that use actions in charmcraft.yaml

include: 
  - tests/

prepare: |
  tests.pkgs install unzip
  charmcraft init --project-dir=charm
  cat <<- EOF >> charmcraft.yaml
  actions:
    pause:
      description: Pause the database.
    resume:
      description: Resume a paused database.
    snapshot:
      description: Take a snapshot of the database.
      params:
        filename:
          type: string
          description: The name of the snapshot file.
        compression:
          type: object
          description: The type of compression to use.
          properties:
            kind:
              type: string
              enum: [gzip, bzip2, xz]
            quality:
              description: Compression quality
              type: integer
              minimum: 0
              maximum: 9
      required: [filename]
      additionalProperties: false
  EOF

restore: |
  pushd charm
  charmcraft clean
  popd
  
  rm -rf charm

execute: |
  cd charm
  charmcraft pack --verbose
  test -f charm*.charm
  unzip -l charm*.charm | grep "actions.yaml"
  unzip -p actions.yaml charm*.charm | grep "Compression quality"
  test ! -d build
