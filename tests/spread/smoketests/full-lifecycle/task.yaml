summary: pack a charm that uses several lifecycle mechanisms and extra files

# Limited to Ubuntu 22.04 and 24.04 because the init profiles no longer work with Python 3.8
systems:
  - ubuntu-22.04-64
  - ubuntu-24.04-64

environment:
  PROFILE/machine: machine
  PROFILE/kubernetes: kubernetes

include:
  - tests/

kill-timeout: 30m

prepare: |
  snap install --classic --no-wait astral-uv
  tests.pkgs install python3-venv
  rm -rf charm
  charmcraft init --project-dir=charm --profile=${PROFILE}

  cp charmcraft-${PROFILE}.yaml charm/charmcraft.yaml

  cd charm
  echo "ignore me" > secrets.txt
  touch extra_file.txt

  # Our templates use tox's uv runner, so we install both.
  snap watch --last=install
  uv tool install --force --with tox-uv tox

restore: |
  pushd charm
  charmcraft clean
  popd

  rm -rf charm

execute: |
  cd charm
  charmcraft pack --verbose
  ~/.local/bin/tox run
  test -f *.charm
  # Charmcraft 3.0 uses the craft-parts standard prime keyword that only
  # includes the specifically mentioned files
  unzip -c *.charm hello.txt | grep "^Hello, world!"
  unzip -l *.charm | NOMATCH "venv/ops/charm.py"
  unzip -l *.charm | MATCH extra_file.txt
  unzip -l *.charm | NOMATCH secrets.txt
